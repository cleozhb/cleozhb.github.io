---
title: 右值引用
date: 2018-08-23 12:44:08
tags: c++
---
在c++语言中按照能否放在赋值操作符“=”的左边或者右边，数值可以分为左值和右值。我们平时用的多的是放在等号左边的左值，能够被赋值，也能够对其他左值赋值。在C++中还有一类数值只能放在等号的右边，只能用于对左值赋值，这样的值为右值。右值通常是一些数值常量、临时变量、无名变量，例如一个函数的返回值就是右值。当使用右值对变量进行赋值时，通常是把右值复制到等号左边的变量，等赋值完成后，不但不保留右值，还要将资源释放掉。例如，从函数中返回一个临时变量，在函数返回后这个临时变量就要被释放掉，而右值引用的引入，可以将一个应用直接指向这个右值。例如从函数中返回一个临时对象：
```
MemoryBlock createBlock(size_t nSize)
{
  return MemoryBlock(nSize);
}
MemoryBlock block = createBlock(703);
```

<!--more-->

如果不使用右值引用，整个函数返回是一个漫长的过程。首先在函数中创建临时MemoryBlock对象，然后创建目标block对象，接着通过函数返回临时对象，并将其复制到MemoryBlock中，最后函数中的临时对象被释放。整个过程进行了同一个对象的多次创建、复制、销毁。如果使用右值引用，这个过程就会简单很多，首先在函数中创建临时对象MemoryBlock；然后当创建目标对象Block时，编译器会检测到对对象赋值的是一个右值，这样编译器就直接使用函数返回的指向临时对象的右值引用完成对象的创建。在这里，Block对象的创建并不是通常的申请内存、初始化对象属性的过程，而是利用右值引用构造函数，直接将整个对象指向右值引用所绑定的对象，即在函数中已经创建的临时对象，再将临时对象移动到目标对象，从而完成目标对象的创建。这样将目标对象直接指向一个右值，省略了中间环节中创建临时对象、销毁、复制的过程。
![图片](1.png)
通过为这个变量所属的类提供可以接受右值引用为参数的赋值操作符"="和构造函数，实现对右值的利用。
![图片](2.png)![图片](3.png)![图片](4.png)
在上面的代码中，MemoryBlock类添加了一个移动构造函数和移动赋值操作符，这使得其具备了利用右值进行构造和赋值的能力。在整个过程中，可以直接移动这个源对象作为自己的对象本身，不会产生新对象的创建与销毁，以及对象之间的内存资源的申请、释放、拷贝操作，减少了中间环节。
