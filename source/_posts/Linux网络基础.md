---
title: Linux网络基础
date: 2018-11-20 23:33:00
tags: [网络, linux]
---

# ISO/OSI七层模型简介
![图片](1.png)
<!--more-->
![图片](2.png)![图片](3.png)四层模型是现在互联网中真正使用的模型，TCP/IP四层模型是建立在七层模型的基础之上的。最下层物理层负责真正的数据传递，最上层最贴近用户。

发送数据是通过接口从上层传递到下层，接收数据是从下层传到上层，整个7层模型就只是模型，无法在计算机中找到。

为什么要进行分层表示呢？
分层便于管理。真正的传输在物理层中，上面所有的层中的并列都是假的，实际是从A7--->A1---->B1--->B7  。7,6,5层负责对用户提供服务，1～4层负责实际的数据传递，5-7层不传数据的时候也要用。实际上只有物理层进行数据的传输，上面的六层都是只写入对应的传输信息，不会有实际的数据交互。下四层是实际的传输层，就会有实际的传输单位。

比特——010101

帧——包含计算机的硬件地址（计算机网卡的硬件地址又叫做MAC地址，MAC地址负责局域网通信，而IP地址负责外网通信）
![图片](4.png)

报文——保存的最重要的作用就是保存IP地址，IP地址在网络层中封装

TPDU——传输协议数据单元
SPDU——会话协议传输单元
PPDU——表示层协议传输单元
APDU——应用协议数据单元
只有物理层负责传输数据，上面的6层都负责写入传输信息，不会有真正的数据交互。数据发送是从上到下，接收是从下到上。

# ISO/OSI七层模型详解
![图片](5.png)
物理层——设备间比特流的传输、物理接口（耳机的接口是尖的，视频的接口是9针的那种）、电气特征。最常见的设备有网线，网卡等。

数据链路层——成帧（在数据包中写入MAC地址），用MAC地址访问媒介（包括发送方和接收方的MAC地址），错误检测与修正（如果传递出错，可以要求重传）

网络层[确定传输地址]——提供逻辑地址（逻辑地址就是IP地址，发送方和接收方的IP地址），选择通路（选择经过哪些路由传递数据）

传输层[确定端口号]——在传输层确定通过那种传输协议来传输，  [ 可靠传输（TCP传输控制协议）与不可靠传输（UDP用户数据报协议）]每种传输协议都有自己的端口，都有66535个端口，然后确定要通过哪个端口发送数据，比如常用的网络服务80端口，邮件服务端口25文件传输服务的端口号是21;  传输前的错误检测，控制流量

会话层：确定数据是否要经过远程会话

表示层：将数据进行数字化表示（将中英文字符翻译成0101的机器码）;特定功能的实现如-加密，压缩;
如果是英文会通过ASCII翻译成机器码，如果是中文会通过GB2312将中文翻译成0101的形式，如果是jpg图片，会通过jpg格式翻译成图片数字编码，如果是mp3也会通过相应的解码方式将其翻译成0101，也就是说常用的后缀名都是为了告诉系统，碰到相关的文件，应该如何进行解码。

应用层：用户接口

例子：用户A给用户B发送一份文件
应用层，打开163邮箱给女朋友写信;

写完了以后点击发送，数据传到表示层将各个格式的数据最终都转换为机器码，该加密加密，该压缩压缩，并进行数字化表示;

写完后传给会话层，由会话层来判断是否需要进行网络传递 ，一看是邮件，将其传递给传输层，贴个信封，如果是PPT不需要进行网络传递，就保存在硬盘上，不会再传递给传输层;

信封有了下面就是在传输层写邮件的收件人，发件人和收件人都写
收件人写完以后在网络层写IP地址（相当于城市）
然后在数据链路层写具体的收件地址（北京路255号）
物理层就是邮局

应用层：163邮箱

表示层：进行数据表示，最终翻译成 0101,压缩加密都在这一层

会话层：进行判断，你发的这个东西会不会进行网络传递，如果是PPT，你点保存的时候数据同样会传到表示层，传到会话层时，会话层会判断这是个PPT，不会进行网络传递，所以不会将其投给传输层，直接将数据交给硬盘，让硬盘保存。如果是邮件，就会传个传输层。

传输层：接到数据，写入邮件的端口号（收件人），确定协议TCP，发送端口25,接收端口110

网络层：写双方的IP地址，负责在互联网传递

数据链路层：打入原MAC地址和目标MAC地址。IP负责在互联网传递，但是数据还是要从一个局域网跳到一个局域网，再跳到下一个局域网，最终到达，MAC就是负责局域网的传递的。

# TCP/IP协议4层模型
![图片](6.png)
![图片](7.png)![图片](8.png)
![图片](9.png)
ARP地址解析协议的作用就是将IP翻译成网卡的物理地址
IP地址是在公网进行数据传输的时候用来确定门牌号，在同一个网段之内也就是局域网内，传递数据就不是靠IP了，而是靠物理地址也就是MAC地址来判断数据应该发给谁。

局域网内传递数据：
a 点击发送（发送目标为同一局域网内的另外一台计算机）---> 
b 数据发到网线上--->
c 网线将请求发到交换机上（交换机只能识别物理地址不会识别IP地址，交换机一接电就会闪一会儿，来记录接在每个端口上的网线连接到的网卡的物理地址，将与交换机每个端口连接的网卡的物理地址记录在交换机中）--->
d 交换机查看接收方的物理地址对应在交换机的哪个端口上，数据直接从该端口发送出去 。

![图片](10.png)
IP协议：对应原IP和目标IP，从而决定数据包在公网当中如何发送
ICMP协议：用来ping的协议

![图片](11.png)
TCP协议是可靠的面向连接的协议（像打电话）
UDP协议是不可靠的面向无连接的协议（像发短信）
![图片](12.png)
什么叫做面向连接可靠的协议呢？
A先向B发送一个SYN包（SYN包是发起连接包）问B“在么”？
B向A发送一个回复包ACK包说“我在，你还在么？”
A响应B说“我在，我要给你发送数据了”
在数据发送的整个过程中A和B之间都是有交流的，包传错了会及时要求重传，所以叫做面向连接

为什么要进行三次握手？
![图片](13.png)两军问题就是TCP三次握手的由来

![图片](14.png)![图片](15.png)上面图片就是对数据的封装和解封装过程。所有数据在实际的传输过程中都会经过这样的一个封装过程。  
发送端从上到下进行数据封装，接受端从下到上进行数据的解封装。 假设用户通过文件服务器上传文件，用户点击发送，数据传递到应用层，应用层判断了这是一个FTP协议，上传的是文件，要使用文件服务器，所以在应用层打入一个包头，告诉对方我要使用FTP服务。然后数据传递到传输层，在传输层中打入传输层协议，记录发送协议是TCP，我的发送端口是...你的接收端口是21。然后数据再传递到网络层，在网络层写入原IP和目标IP。然后数据继续传递到数据链路层，主要指传入原MAC地址和目标MAC地址;数据就此打好包通过网线向对方传递。传到对方后，数据反过来了，在数据链路层先判断目标MAC地址是不是我，如果是，往上传，如果不是丢弃，然后传到网络层，判断目标IP是不是我，如果是，往上传，同时把TCP包头拆掉，传输层判断目标端口为21,说明要投给我的当前服务器的FTP服务器，所以就传递给FTP服务器来响应，FTP一看这确实是给我的，所以将FTP包头拆掉，然后用户使用FTP对应的工具，读取对应的数据。

![图片](16.png)

# IP地址详解
IP地址是什么？怎么表示？怎么分类？
我们在网络层打入的IP包头到底是什么样子的呢？
如下图所示：IP包头一行是32位，共有5行就是32×5 = 160位。每8位代表一个字节，所以IP包头的固定长度是20个字节。但是IP包头还有些有可能有的选项，所以不一定是20个字节，这也是目前IPV4没有IPV6快的主要原因。因为协议的包头长度是不固定的，有可能是20个字节也有可能比20个字节长，所以每接收一个数据，都要先检测包头有多长，才能将包头取下来，这是非常浪费资源的，而IPV6中的包头固定字节长度。
![图片](17.png)

在包头中会描述源IP和目标IP，但是描述IP地址的位数只有32位，所以在IPV4的数据包中，IP地址的数量总共只有2^32大概是42亿9000万这么多，因为这是包头规定的。实际的IP地址将数据分成4组，用点隔开。换算成十进制就是下面0-255的范围。
![图片](18.png)但并不是这个范围内所有的值都可以作为IP地址。
![图片](19.png)分为ABCDE5类，但是DE不在民用范围内。
判断网络类别只需要看第一个数字就行
A：1-126
B：128-191
C：192-223
我们能用的最大IP地址数其实是223

同一个网段之间通信只要通过交换机就可以了，而不同网段之间通信需要通过路由器。
127.0.0.0代表计算机自己，所以不属于ABC

A类，第一个数代表网段，后3个数代表不同网段的不同主机，所以后3个数总共有24位，最大主机数就为2^24-2。A类网络中只要第一个数变化就表示不是一个网段，后面的3个数变化只能代表一个网段中不同的主机。所以A类的网段数量只有126,但是主机数有2^24-2，减2是因为每个网络的第一个地址也就是1.0.0.0代表网络本身不能分配，而1.255.255.255代表当前网络的广播地址也不能分配。

B类，前两个数代表网段，后两个数代表不同网段中的不同主机，主机数计算方法同上。
![图片](20.png)


C类，前三个数代表不同网段，后一个数代表一个网段中的不同主机，所以能用的主机数是2^8-2。
这个分类是人为规定的，我们就用第一个IP来确定网络的分类，至于每个网段有多上个主机是用子网掩码来确定的，IP是不能决定的。但是每个IP都有标准子网掩码，上图所示都是用标准子网掩码来定义的。 
私有IP（免费）是用于内网的，可以解决像学校等单位的网络问题，也是最好的保护公网IP的方法。IPV4只能提供四十二亿九千万个IP地址，其实早就不够用了。私有IP不能直接访问互联网，需要与公网IP之间进行转换才能访问互联网。IP地址是互联网上唯一的门牌号，大家都可以免费开，所以不能直接访问互联网。

# 子网掩码
ABC类有不同的网段个数和主机个数， 这些个数的不同就是由子网掩码决定的，子网掩码不能与IP地址分开查看，不能单独使用，所以上一节中所说的分了几个网段，每个网段有多少个主机，其实都是默认用标准的子网掩码来做匹配。

![图片](21.png)
A类网络的标准子网掩码就是255.0.0.0


![图片](22.png)
B类网络的标准子网掩码就是255.255.0.0


![图片](23.png)
C类网络的标准子网掩码就是255.255.255.0

子网掩码用来确定IP地址当中哪个数变化对应不同的网段，哪个数变化对应网段中不同的主机。只要是跟255对应的IP变化就是不同的网段，与0对应的IP变化就是一个网段中的不同的主机。子网掩码不一定要写成由255和0组成的。它其实是可以变化的，唯一的规则就是，子网掩码的二进制形式中1的那部分连续就可以了。
![图片](24.png)
上图所示为给一个B类的IP地址分配了C类的子网掩码，所以换算方式就会变成跟C类完全一样，前3个数变代表不同网段，最后一个数变代表同一个网段中的不同主机。
网络地址是子网掩码与IP相&，&出来是多少就是网络地址
广播地址，先看子网掩码的0位有多少位，有多少位就将IP地址的后多少位全部换为1，这个值就是广播地址。
并不是B类IP 一定要分配255.255.0.0这样的子网掩码，可以随意指定，只要1是连续的，没有断开，就是合理的，然后分配不同的子网掩码，IP地址的计算方式就会发生很大的变化。

# 端口的作用

端口号是什么？
端口号有多少种分类？
常见的端口号有哪些？

你通过IP确定对方服务器的位置，但对方的服务器可能开启很多服务，你通过IP找到服务器之后到底要服务器提供哪个服务呢？需要告诉服务器端访问的目标端口是谁，这就是服务器端最重要的作用，标记服务器开启的端口和访问的是谁。也就是说常见服务端口应该是固定的，可以改，但是改了以后客户端并不知道，相当于将服务藏起来了。如果服务是对外提供的那么端口号就应该是固定的，比如网页服务的端口号就应该是80。

![图片](25.png)

TCP包头和IP包头非常类似，也是默认大小为20个字节，也就是160位。但是端口号是16位的，源端口和目标端口都是16位，占据TCP包头的第一行。可用端口号范围为0～2^16 共65535个端口。

![图片](26.png)
UDP包头比TCP包头简单，在使用和确认的时候使用的资源更少，所以更快。无论是TCP协议还是UDP协议，端口数量都是固定的，各有65535个。端口的数量是由协议决定的。

为什么是TCP协议和UDP协议中保存端口信息呢？
因为在传输层用来确定端口的，传输层的协议就TCP和UDP。所以这两个协议确定源端口和目标端口。
源端口：发送端口
目标端口：服务器接收数据的接收端口，通过目标端口就可以确定目标端口上开启了哪些服务。

一万以内的端口一般为常用端口给系统用的，超过一万的端口一般是我们自己写的程序等。
![图片](27)
FTP协议端口
20：进行数据传递
21：用来进行登录传输命令
SSH协议（linux的远程管理协议）
telnet:明文传递，所以现在的操作系统win，linux都禁止开放23号端口
SMTP：25 发邮件端口
POP3：110 收信端口

# DNS的作用
![图片](28.png)
![图片](29.png)

把DNS叫做Domain Name System的缩写，也就是域名系统的缩写，也称为名称解析。
负责将域名翻译成IP，或者将IP翻译成域名。让人和计算机都能找到习惯的表示方式。
windows中的hosts文件是做静态IP和域名的对应，在hosts文件中定义的域名和IP的对应，优先于DNS域名解析，也就是说比访问公网的域名解析的优先级更高，只要这里写了，就不会再去找公网中真正的IP而是按照hosts文件中的IP地址去找，通过修改hosts文件访问google的一种方法吧，哈哈

ping的时候如果在hosts中没有找到，就会去找公网上真正的IP，hosts文件的优先级高于DNS解析。
![图片](30.png)
![图片](31.png)
DNS服务器的工作原理：
每个客户机都会写清楚自己客户机的IP地址。当要访问一个网站，首先向DNS服务器发送一个请求说“我要访问imooc网站”，客户机会问DNS“你知道这个网站的IP么？”。DNS是负责这个事儿的，就会将IP地址告诉客户机，客户机拿到IP之后就会去访问真正的imooc网站。


![图片](32.png)
域名空间结构又叫做完全合格域名，域名用“.”分割便于分级管理。“.”表示根域名，是全球所有DNS都知道，根域名服务器只有13台（在中国大陆是没有的）。所有的DNS都知道根域名在哪儿。
DNS服务器是怎么知道域名所对应的IP的呢？
DNS服务器也不知道域名对应的IP，它是知道后台的根域名的IP。
根域中保存了顶级域（也叫做一级域）一级域是由ISO域名分配组织决定的，常见的一级域分为组织一级域和国家一级域。
![图片](33.png)
  ![图片](34.png)
![图片](35.png).com和.cn都是一级域分别为组织一级域和国家一级域。
二级域是由个人或者组织向域名分配组织申请的。域名是买来的。。。
三级域名也叫组织域名是申请外二级域名之后自己规定的。一般用www代表网页服务。
三级域+二级域+顶级域组成完整的域名空间，且域名全球唯一！只有这三个级别的域名都存在时才是一个完整的域名，才全球唯一。
大公司在申请域名的时候尽量将后缀为.com, .com.cn, .cn都申请了，保证不管怎么访问都是访问到该公司，免得被人误导。

为什么讲域名空间呢？
首先，互联网中域名是有结构有规划的。第二，域名进行了分级，在进行域名和IP地址解析的时候才更容易找到，根域名只负责管理一级域名，每个一级域名负责管理自己的二级域名，二级域名负责管理三级域名，这样出问题了容易排查。

防范钓鱼网站：看看二级域名和一级域名加起来是不是正常的地址，不要管后面的一堆东西。

DNS是怎么将它不知道的域名翻译成IP地址的呢？
![图片](36.png)
DNS客户机想本地域名服务器发起请求访问“[www.imooc.com.cn](http://www.imooc.com.cn)”时，本地域名服务器如果曾今解析过，它会缓存一段时间（默认的时间是3天），知道imooc网站的IP地址，直接返回给客户机。但是如果是第一次向DNS服务器发起这个请求，本地域名服务器就会去问根DNS服务器（所有的DNS服务器都知道全球的根DNS服务器在哪儿），根DNS服务器可能也不知道imooc网站的完整的域名地址，但根DNS服务器知道.cn这个一级域的IP，根DNS服务器会将.cn这个一级域的IP告诉本地域名服务器。本地域名服务器再去问.cn这个一级DNS服务器是否知道imooc的IP，结果它也不知道，但是它知道.com.cn这个一级域的IP，同样返回给本地域名服务器。重复这个过程直到找到IP为止。

这个过程相对而言还是比较复杂的，要进行很多次查询，所以本地DNS服务器一定是要做保存的。
递归查询：客户机想本地域名服务器的查询叫做递归查询，一定要返回正确的IP地址，或者返回找不到报错。也就是说递归查询要么返回结果要么报错。
迭代查询：DNS服务器之间的查询叫做迭代查询。不一定要返回正确的IP地址，只要返回最接近的最优化的值就行了，比如过程2返回.cn一级域名DNS服务器的IP，过程3返回.com.cn的IP，过程4返回imooc.com.cn的IP地址。 
![图片](37.png)

# 网关的作用
![图片](38.png)
![图片](39.png)
![图片](40.png)
交换机不认识IP地址，交换机只认识MAC地址。进行的是局域网内的通信。
路由器用于在不同的网段之间进行数据交换的。
网关：具有路由功能的网络设备。一般情况下是路由器，当然也可以用一个服务器，在服务器上搭建路由功能。网关还有它的网关。一级一级最终达到目的地。
网关的作用：1.当要访问外网时数据就要交给网关来处理。2.内网IP是不能直接访问公网的，公网也不能直接访问内网IP，在每个局域网内可能会出现同样的IP地址，而IP作为计算机在互联网上的唯一标志，所以不能访问，必须经过网关进行IP地址转换，将内网IP翻译成真正的公网IP，这个公网IP才是全球唯一的，才可以真正访问互联网的作用。

如果不配置网关，不配置DNS，只配置了IP地址和子网掩码，当前计算机是不能访问公网的，但是能在局域网内进行通信的。要想访问公网，必须用网关将数据报转为公网IP，必须有DNS将网页的域名请求转换为翻译成真正的IP地址，才可以进行正常的公网使用，这就是IP，子网掩码，网关，DNS服务器的作用。

# linux网络配置之IP地址配置
![图片](41.png)
![图片](42.png)
![图片](43.png)
在windows中，可以自动获取IP地址，也可以手动指定IP地址。自动获取IP有个前提条件就是在局域网内有自动分配IP地址的dhcp服务器。
![图片](44.png)
![图片](45.png)
![图片](46.png)
用netstat -tunl 来查询当前计算机开了哪些端口，从而判断当前计算机开了哪些服务
netstat -an 看有谁连接到当前服务器上了
![图片](47.png)
![图片](48.png)
![图片](49.png)

如果给eth0也设置了网关，数据报传到eth0以后怎么办，一般会瞎编一个网关，这个网关很有可能根本就不存在或者还是在局域网当中，也就是说当这个网卡不知道数据报该如何处理时就会交给网关来处理，但是你这个网关又写的是eth0本身，相当于将数据报又提交给了自己，此时eth0就晕菜了。所以只有连接外网的网卡才可以设置网关，网关是由运维商电信网通等设置好的，他们会告诉你下一级网关在哪儿，所以在一台服务器里面连接内网的网卡是不能设置网关的。
![图片](50.png)
![图片](51.png)

ifconfig能够看到IP地址和子网掩码
netstat -rn能够看到网关
nslookup 看到DNS服务器，用来翻译域名对应哪个IP
![图片](52.png)

# linux常用网络测试命令
![图片](53.png)
ping向指定的IP发送了一个icmp协议的数据包，对方会有回应。

![图片](54.png)
测试192.168.0.252 的80端口能不能正常连接。如果不能连有可能是对方没有开相关的服务，也有可能是对方开了防火墙将其屏蔽了，总之就是不能正常访问了。

![图片](55.png)

查看访问一个网站都经过了哪些路由路径访问的，比如访问imooc，我们虽然不能决定路由路径，这是自动由路由协议来控制的，但是至少可以查看。 
![图片](56.png)
traceroute跟ping一样都是用ICMP协议，用它来进行远程探测，如果对方网站禁止ping那就看不到路由节点的。但是这个命令是很有用的，比如有一天你发现你的服务器连不上了，那就可以再执行着一条命令，从中间去看，到哪个节点数据的包过不去了，如果是内网节点，说明是自己的包出问题了，自己解决即可，如果是公网的某个节点出了问题，那就找运维商说名出问题的节点。有助于进行故障定位。
![图片](57.png)
![图片](58.png) 
在互联网上只有https是加密协议， 绝大多数的数据报都是明文的，互联网并不安全。

# SSH协议原理
常用的Xshell和WinSCP文件传输工具都是依据SSH协议产生的，所以我们要学习SSH协议的原理。SSH是一个加密的远程的安全的管理方法，所以我们先要学习一下加密算法的一些简单的概念。
传统的对称加密算法
![图片](59.png)
![图片](60.png)
![图片](61.png)

屌丝有个东西要传给高富帅，对称加密算法中，要解密高富帅就必须要拿到屌丝的密码。这个密码可能还用在了多个网站，这是极其不安全的。如果是采用非对称加密，屌丝用自己的密码使用对称加密工具生成一个公钥一个私玥，公钥相当于锁，私玥相当于钥匙，公钥可以对外公开，私玥只有自己拥有。高富帅也生成自己的公钥和私玥。如果屌丝要发送一个文件确定要让高富帅来看，这时候就要问高富帅要他的公钥B，屌丝拿着高富帅的公钥B和自己的公钥A加密文件，也就是说想让谁看文件，就要用谁的公钥加密。这时候文件传到对方，高富帅只要用自己的私玥和自己的密码就可以解开文件，不需要知道屌丝的密码。最重要的目标就是保护发送端的密码安全。
重要文件放入一个圆柱型的服务器中，一头用自己的公钥A锁上，另一头用高富帅的公钥B锁上，两边都有门。想让谁看到，就必须在加密时将其公钥加到文件当中。若自己想看就用自己的私玥和密码开左边的门，高富帅想看就用他的私玥加他的密码开右边的门，取出对应的数据。这样发送方不需要将自己的密码告诉对方，保证了密码安全。这就是非对称加密。

对称加密和非对称加密指的都是加密文件的加密算法，但是在linux中，远程连接工具在非对称加密之上演变而来。
![图片](62.png) 
SSH只是保证密码传递过程中的安全，要做到真正的安全当然还要密码设置时足够复杂，防止被暴力破解，接收端的电脑上没有病毒，等一整套的防范措施。
![图片](63.png)
![图片](64.png)第一次连接的时候会问是否要将对方的公钥下载过来，输入yes然后输入密码才可以登录。然后后面的每次交互都要通过这个公钥进行加密。
如果所连接的计算机重装了，或者它的IP被其他计算机抢占了，如果仍然使用当前这个公钥，是否还能够正常管理登录呢？当然是不可以的。需要重新下载公钥。




