---
title: 记实验室code review
date: 2018-09-12 12:22:20
tags: 编码规范
---

2018年9月11号晚上，实验室在姚老师的领导下进行了第一次code review。姚老师结合同学的代码讲了很多与编码规范相关的东西。现在记录如下。

核心思想是代码逻辑清晰可读，只读主函数就可以看懂程序的逻辑，整个程序的执行步骤先做什么后做什么，有必要的注释，所有变量命名和函数名具有自注释性。

* 整个程序只有在主函数中可以容忍出现megic number并要求用宏定义
* 在所有的文件中不可以出现绝对路径（除了主函数）
* 在VS下编码的时候，将库拷贝到当前目录，用相对路径引入库，以便于代码移植，如果用绝对路径会导致这个工程在别的机器上跑的时候全部要重新配置一遍所有的库
* 控制代码的粒度和可复用性

<!--more-->

* 函数的命名与变量的命名要有明显的区别，严格按照驼峰命名法，否则你只看名字是分不清是函数还是变量的
* 注意返回值，函数的返回值不能乱写。尤其是在linux下，函数返回负值说明执行失败，返回正值说明执行成功.
* 容灾性设计：当函数出错了怎么办，内存申请不成功怎么办
* 在头文件中，不要用命名空间using namespace，很容易出现冲突。老老实实加上命名空间调用函数;
* 在程序中注意英文的用词，比如遥感影像都是用image，不能用photo, picture ;开源出去不能丢脸，会让人觉得很不专业
* 代码中的每个部分从上到下具有逻辑性，控制好函数的粒度; 能解释清楚每个部分做了什么，一个函数中不同的逻辑部分用换行分段，将不同含义的变量定义分开。比如下图多次用public:将不同功能类型的函数声明分开;

![图片](1.png)

* 全局变量尽量少声明，如果一定要声明，可以在.h文件中用extern关键字修饰声明，然后在main函数中定义。
* 不要出现写死的文件路径，文件名等，学会用argc,argv传入参数;
* 注意适配性的问题; 如果传入的参数多，可以用xml文件，只需要在程序中解析xml文件就不用每次都输入很长的参数了;xml文件的标签名需要简单易懂;

* 一个变量要一眼就能看出来是函数名还是变量名，是什么类型的，是输入还是输出;
* 不要一会儿用malloc一会儿用new，在代码中统一，否则在释放的时候很容易用错delete和free
* 尽量不要用全局变量，将其封装在类或结构体里面;

使用全局变量的优点是：可以减少变量的个数，减少由于实际参数和形式参数的数据传递带来的时间消耗。但是，使用全局变量也有许多缺点：

1. 全局变量保存在静态存贮区，程序开始运行时为其分配内存，程序结束释放该内存。与局部变量的动态分配、动态释放相比，生存期比较长，因此过多的全局变量会占用较多的内存单元。

2. 全局变量破坏了函数的封装性能。函数像一个黑匣子，一般是通过函数参数和返回值进行输入输出，函数内部实现相对独立。但函数中如果使用了全局变量，那么函数体内的语句就可以绕过函数参数和返回值进行存取，这种情况破坏了函数的独立性，使函数对全局变量产生依赖。同时，也降低了该函数的可移植性。

3. 全局变量使函数的代码可读性降低。由于多个函数都可能使用全局变量，函数执行时全局变量的值可能随时发生变化，对于程序的查错和调试都非常不利。如果程序必须被修改，则全局依赖增加了引入错误的可能性，而且既使只对局部做修改也要求程序员必须理解整个程序。

* 代码的粒度没有控制好，有很多有重复代码的，且一个函数过长;
* 在内存空间没有申请上的时候保证代码可以正常的退出，而不是接着往下执行;
* 线程块大小的设计不要用magic number ，自动计算出一个最何时的值，或者外部通过参数传进来;
* 返回值是有含义的，尤其是发生错误时的返回值，便于查错，每个返回值都要有特定的含义，并在程序的说明文件中说明，在linux中，通常情况下，如果程序发生错误，返回负值，如果程序正常结束，返回正值;

